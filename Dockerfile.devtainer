FROM ubuntu:24.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Copy uv from official container (multi-arch, auto-detects platform)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Install base dependencies (including gvm requirements and network tools)
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    ca-certificates \
    gnupg \
    software-properties-common \
    procps \
    bison \
    bsdmainutils \
    iputils-ping \
    net-tools \
    dnsutils \
    iproute2 \
    traceroute \
    netcat-openbsd \
    ripgrep \
    fd-find \
    unzip \
    htop \
    && rm -rf /var/lib/apt/lists/*

# Install Neovim 0.11.4 (required for LazyVim)
RUN curl -LO https://github.com/neovim/neovim/releases/download/v0.11.4/nvim-linux-arm64.tar.gz && \
    tar -C /usr/local -xzf nvim-linux-arm64.tar.gz --strip-components=1 && \
    rm nvim-linux-arm64.tar.gz

# Install Python 3.14
RUN add-apt-repository -y ppa:deadsnakes/ppa && \
    apt-get update && apt-get install -y \
    python3.14 \
    python3.14-venv \
    python3.14-dev \
    python3-pip \
    && rm -rf /var/lib/apt/lists/* && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.14 1

# Install common Python tools globally
RUN pip3 install --no-cache-dir --break-system-packages \
    poetry \
    pipenv

# Create non-root user
RUN useradd -ms /bin/bash dev && \
    mkdir -p /home/dev/.npm /home/dev/.cache && \
    chown -R dev:dev /home/dev

USER dev
WORKDIR /home/dev

# Install nvm and latest Node.js
ENV NVM_DIR=/home/dev/.nvm
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash && \
    . $NVM_DIR/nvm.sh && \
    nvm install node && \
    nvm use node && \
    nvm alias default node && \
    npm install -g yarn

# Install gvm and latest Go
SHELL ["/bin/bash", "-c"]
RUN curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer | bash && \
    source /home/dev/.gvm/scripts/gvm && \
    gvm install go1.23.4 -B && \
    gvm use go1.23.4 --default

# Install LazyVim
RUN git clone https://github.com/LazyVim/starter ~/.config/nvim && \
    rm -rf ~/.config/nvim/.git

# Add nvm and gvm initialization to bashrc for interactive shells
RUN echo 'export NVM_DIR="$HOME/.nvm"' >> /home/dev/.bashrc && \
    echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> /home/dev/.bashrc && \
    echo '[[ -s "$HOME/.gvm/scripts/gvm" ]] && source "$HOME/.gvm/scripts/gvm"' >> /home/dev/.bashrc && \
    echo 'alias fd=fdfind' >> /home/dev/.bashrc

# Setup environment for non-interactive shells
ENV HOME=/home/dev

# Pre-install LazyVim plugins (optional - speeds up first run)
RUN nvim --headless "+Lazy! sync" +qa

# Verify installations
RUN . $NVM_DIR/nvm.sh && \
    . /home/dev/.gvm/scripts/gvm && \
    node --version && \
    npm --version && \
    yarn --version && \
    go version && \
    python3 --version && \
    uv --version && \
    nvim --version

# Default shell
CMD ["/bin/bash"]
